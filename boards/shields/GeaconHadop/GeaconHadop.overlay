#include <dt-bindings/zmk/bt.h>
#include <input/processors.dtsi>
#include <dt-bindings/zmk/input_transform.h>
#include <zephyr/dt-bindings/input/input-event-codes.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/pointing.h>
#include "GeaconHadop_pinctrl.dtsi"
#include <dt-bindings/zmk/matrix_transform.h>
#include <behaviors/rgbled_widget.dtsi>
#include <physical_layouts.dtsi>

/ {
	chosen {
        zephyr,display = &oled;
		zmk,physical-layout = &layout_Hadop;
	};
	
	default_transform: keymap_transform_0 {
		compatible = "zmk,matrix-transform";
		columns = <15>;
		rows = <7>;
		
		map = <
		RC(0,8)   RC(1,8)   RC(2,8)   RC(3,8)   RC(4,8)   RC(5,8)   RC(6,8)  RC(7,8)  RC(0,7)  RC(1,7)  RC(2,7)
		RC(0,6)   RC(1,6)   RC(2,6)   RC(3,6)   RC(4,6)   RC(5,6)   RC(7,6)  RC(8,6)  RC(0,5)  RC(1,5)  RC(2,5)  RC(3,5)
	    RC(4,5)   RC(0,4)   RC(1,4)   RC(2,4)   RC(3,4)   RC(5,4)   RC(6,4)  RC(7,4)  RC(8,4)  RC(0,3)  RC(1,3)  RC(2,3)
		RC(0,2)   RC(1,2)   RC(3,2)   RC(4,2)   RC(5,2)   RC(6,2)   RC(7,2)  RC(8,2)  RC(0,1)  RC(2,1)           RC(3,1)
		RC(4,1)   RC(5,1)   RC(6,1)   RC(7,1)   RC(8,1)   RC(1,0)                                      RC(2,0)   RC(3,0)  RC(4,0)
		>;
	};

    glidepoint_listener_L: glidepoint_listener_L {
        compatible = "zmk,input-listener";
        status = "okay";
        device = <&glidepoint>;
        
        input-processors = <
            &zip_xy_transform (INPUT_TRANSFORM_XY_SWAP | INPUT_TRANSFORM_Y_INVERT)
            &zip_temp_layer 3 100
        >;

        scroller {
            layers = <5>;
            input-processors = <
                &zip_xy_transform (INPUT_TRANSFORM_XY_SWAP | INPUT_TRANSFORM_X_INVERT)
                &zip_xy_scaler 1 20
                &zip_xy_to_scroll_mapper
            >;
        };
    };
    	
    zip_keybind_keys: zip_keybind_keys {
        compatible = "zmk,input-processor-keybind";
        #input-processor-cells = <0>;
        bindings = <&kp RIGHT>,
                   <&kp LEFT>,
                   <&kp UP>,
                   <&kp DOWN>;
        tick = <40>;
        wait-ms = <0>;
        tap-ms = <10>;
    };

    kscan0: kscan0 {
        compatible = "zmk,kscan-gpio-charlieplex";
        interrupt-gpios = <&xiao_d 6 (GPIO_ACTIVE_LOW)>;
        gpios
            = <&xiao_d 0 (GPIO_ACTIVE_LOW)>
            , <&xiao_d 1 (GPIO_ACTIVE_LOW)>
            , <&xiao_d 2 (GPIO_ACTIVE_LOW)>
            , <&xiao_d 3 (GPIO_ACTIVE_LOW)>
            , <&xiao_d 7 (GPIO_ACTIVE_LOW)>
            , <&xiao_d 8 (GPIO_ACTIVE_LOW)>
            , <&xiao_d 9 (GPIO_ACTIVE_LOW)>
            , <&xiao_d 10 (GPIO_ACTIVE_LOW)>
            , <&gpio0 9 (GPIO_ACTIVE_LOW)>
            ;
    };

	layout_Hadop: layout_Hadop {
		compatible = "zmk,physical-layout";
		display-name = "GeaconHadop";
		transform = <&default_transform>;
		kscan = <&kscan0>;
		
        keys  //                     w   h    x    y     rot    rx    ry
            = <&key_physical_attrs 150 100   50    0       0     0     0>
            , <&key_physical_attrs 100 100   50  100       0     0     0>
            , <&key_physical_attrs 125 100 1150  100       0     0     0>
            , <&key_physical_attrs 125 100   50  200       0     0     0>
            , <&key_physical_attrs 100 100 1175  200       0     0     0>
            , <&key_physical_attrs 175 100   50  300       0     0     0>
            , <&key_physical_attrs 100 100 1150  325       0     0     0>
            , <&key_physical_attrs 100 100  625  355       0     0     0>
            , <&key_physical_attrs 100 100   50  400       0     0     0>
            , <&key_physical_attrs 100 100  150  400       0     0     0>
            , <&key_physical_attrs 100 100 1050  425       0     0     0>
            , <&key_physical_attrs 100 100 1150  425       0     0     0>
            , <&key_physical_attrs 100 100 1250  425       0     0     0>
            , <&key_physical_attrs 100 100  150  100     125   200   150>
            , <&key_physical_attrs 100 100  600   54     125   650   104>
            , <&key_physical_attrs 100 100  175  201     250   225   251>
            , <&key_physical_attrs 100 100  575  254     250   625   304>
            , <&key_physical_attrs 100 100  201    2     375   251    52>
            , <&key_physical_attrs 100 100  549  152     375   599   202>
            , <&key_physical_attrs 100 100  473  451     445   585   951>
            , <&key_physical_attrs 100 100  226  304     500   276   354>
            , <&key_physical_attrs 100 100  524  350     500   574   400>
            , <&key_physical_attrs 100 100  251  107     625   301   157>
            , <&key_physical_attrs 100 100  499   48     625   549    98>
            , <&key_physical_attrs 100 100  253  409     700   316   459>
            , <&key_physical_attrs 100 100  276  210     750   326   260>
            , <&key_physical_attrs 100 100  474  245     750   524   295>
            , <&key_physical_attrs 100 100  301   13     875   351    63>
            , <&key_physical_attrs 100 100  449  141     875   499   191>
            , <&key_physical_attrs 100 100  326  318    1000   376   368>
            , <&key_physical_attrs 100 100  424  337    1000   474   387>
            , <&key_physical_attrs 100 100  350  122    1125   400   172>
            , <&key_physical_attrs 100 100  400   33    1125   450    83>
            , <&key_physical_attrs 100 100  382  435    1195   457   485>
            , <&key_physical_attrs 100 100  375  227    1250   425   277>
            , <&key_physical_attrs 100 100  875  227 (-1250)   925   277>
            , <&key_physical_attrs 100 100  850  133 (-1125)   900   183>
            , <&key_physical_attrs 100 100  900   22 (-1125)   950    72>
            , <&key_physical_attrs 100 100  826  337 (-1000)   876   387>
            , <&key_physical_attrs 100 100  924  318 (-1000)   974   368>
            , <&key_physical_attrs 100 100  801   41  (-875)   851    91>
            , <&key_physical_attrs 100 100  949  113  (-875)   999   163>
            , <&key_physical_attrs 100 100  776  245  (-750)   826   295>
            , <&key_physical_attrs 100 100  974  210  (-750)  1024   260>
            , <&key_physical_attrs 100 100  751  148  (-625)   801   198>
            , <&key_physical_attrs 100 100  999    7  (-625)  1049    57>
            , <&key_physical_attrs 100 100  726  350  (-500)   776   400>
            , <&key_physical_attrs 100 100 1024  304  (-500)  1074   354>
            , <&key_physical_attrs 100 100  677  451  (-445)   765   951>
            , <&key_physical_attrs 100 100  701   52  (-375)   751   102>
            , <&key_physical_attrs 100 100 1049  102  (-375)  1099   152>
            , <&key_physical_attrs 100 100  675  254  (-250)   725   304>
            , <&key_physical_attrs 100 100 1075  201  (-250)  1125   251>
            , <&key_physical_attrs 100 100  650  154  (-125)   700   204>
            , <&key_physical_attrs 100 100 1150    0  (-125)  1150    50>
            ;
	};
    
    aliases {
        led-red = &led0;
        led-green = &led1;
        led-blue = &led2;
    };

    leds {
        compatible = "gpio-leds";
        status = "okay";
        led0: led_0 {
            gpios = <&gpio0 26 GPIO_ACTIVE_LOW>;  // red LED, connected to P0.26
        };
        led1: led_1 {
            gpios = <&gpio0 30 GPIO_ACTIVE_LOW>;  // green LED, connected to P0.30
        };
        led2: led_2 {
            gpios = <&gpio0 6 GPIO_ACTIVE_LOW>;  // blue LED, connected to P0.06
        };
    };
};

&adc {
	status = "okay";
};

&xiao_i2c {
    status = "okay";
    compatible = "nordic,nrf-twi";
    pinctrl-0 = <&i2c0_default>;
    pinctrl-1 = <&i2c0_sleep>;
    pinctrl-names = "default", "sleep";
    
    clock-frequency = <100000>; 
    oled: ssd1306@3c {
        compatible = "solomon,ssd1306fb";
        reg = <0x3c>;
        width = <128>;
        height = <32>;
        segment-offset = <0>;
        page-offset = <0>;
        display-offset = <0>;
        multiplex-ratio = <31>;
        // segment-remap;
        // com-invdir;
        com-sequential;
        inversion-on;
        prechargep = <0x22>;
    };
    
    glidepoint: glidepoint@2a {
        compatible = "cirque,pinnacle";
        reg = <0x2a>;
        status = "okay";
        dr-gpios = <&gpio0 10 (GPIO_ACTIVE_HIGH)>;

        sensitivity = "2x";
        // sleep;
        no-taps;
    };
};

&xiao_serial { status = "disabled"; };
&uart0 { status = "disabled";};